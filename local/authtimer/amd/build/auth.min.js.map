{"version":3,"file":"auth.min.js","sources":["../src/auth.js"],"sourcesContent":["// eslint-disable\r\ndefine(['jquery',\r\n    './modal',\r\n    'core/modal_events',\r\n    'core/ajax',\r\n    'core/templates',\r\n    'core/notification',\r\n    'core/event',\r\n    'core/str',\r\n    'theme_boost/form-display-errors',\r\n    './loadingicon',\r\n    'core/config',\r\n    './toast',\r\n    'core_form/events'\r\n], function ($,\r\n                              Modal,\r\n                              ModalEvents,\r\n                              Ajax,\r\n                              Templates,\r\n                              Notification,\r\n                              Event,\r\n                              Str,\r\n                              displayErrors,\r\n                              Loader,\r\n                              config,\r\n                              Toast,\r\n             formEvents) {\r\n    var component = 'local_authtimer';\r\n\r\n    var CONSTANTS = {\r\n        modaltemplate: component + '/authmodal',\r\n        mailaction: '[data-action=\"mail\"]',\r\n        close: '[data-action=\"hide\"]',\r\n        closebtn: '[data-action=\"cancel\"]',\r\n        codeinput: '#id_code',\r\n        clicktosend: '#id_clicktosend',\r\n        mailajax: component + '_mail',\r\n        authajax: component + '_authenticate',\r\n        content: '.modal-content',\r\n        authbodyclass: 'authmodeon',\r\n    };\r\n\r\n    var sectomilisec = function (sec) {\r\n        return sec * 1000;\r\n    };\r\n\r\n    function init(timeInterval) {\r\n        $.when(\r\n            Str.get_strings([\r\n                {key: 'cannotsendmail', component: component},\r\n                {key: 'emailcodeinvalid', component: component},\r\n                {key: 'emailsent', component: component},\r\n            ]),\r\n            Templates.render(CONSTANTS.modaltemplate, {})\r\n        ).then(function (strings, htmljs) {\r\n            Templates.runTemplateJS(htmljs[1]);\r\n            var modal = new Modal.ModalSaveCancel(htmljs[0]);\r\n            var modalRoot = modal.getRoot();\r\n            var codeinput = modalRoot.find(CONSTANTS.codeinput);\r\n            var clicktosend = modalRoot.find(CONSTANTS.clicktosend);\r\n            var errEvent = $.Event(Event.Events.FORM_FIELD_VALIDATION);\r\n            var modalContent = modalRoot.find(CONSTANTS.content);\r\n\r\n            modal.getModal().attr('data-modaltheme', 'adaptable');\r\n\r\n            function modalSave(e) {\r\n                e.preventDefault();\r\n\r\n                formEvents.notifyFieldValidationFailure(codeinput[0], '');\r\n\r\n                var codeval = codeinput.val().trim();\r\n\r\n                if (codeval.length === 0) {\r\n                    formEvents.notifyFieldValidationFailure(codeinput[0], strings[1]);\r\n                    return false;\r\n                }\r\n\r\n                var promises = Ajax.call([{\r\n                    methodname: CONSTANTS.authajax,\r\n                    args: {\r\n                        contextid: config.contextid,\r\n                        authcode: codeval,\r\n                    }\r\n                }]);\r\n\r\n                Loader.addIconToContainerRemoveOnCompletion(modalContent, promises[0]);\r\n\r\n                promises[0].then(function (response) {\r\n                    if (!response.success) {\r\n                        formEvents.notifyFieldValidationFailure(codeinput[0], strings[1]);\r\n                    } else {\r\n                        modal.hide();\r\n                        codeinput.val('');\r\n                        formEvents.notifyFieldValidationFailure(codeinput[0], '');\r\n                        if (response.nexttick) {\r\n                            // Const tick = setInterval(() => window.console.log(1), sectomilisec(1));\r\n                            setInterval(function () {\r\n                                modal.show();\r\n                                // ClearInterval(tick);\r\n                            }, sectomilisec(response.nexttick));\r\n                        }\r\n                    }\r\n                    return true;\r\n                }).fail(Notification.exception);\r\n\r\n                return false;\r\n            }\r\n\r\n            modalRoot.on('click', CONSTANTS.mailaction, function (e) {\r\n                e.preventDefault();\r\n\r\n                clicktosend.trigger(errEvent, '');\r\n                codeinput.trigger(errEvent, '');\r\n\r\n                var promises = Ajax.call([{\r\n                    methodname: CONSTANTS.mailajax,\r\n                    args: {\r\n                        contextid: config.contextid,\r\n                    }\r\n                }]);\r\n\r\n                Loader.addIconToContainerRemoveOnCompletion(modalContent, promises[0]);\r\n\r\n                promises[0].then(function (response) {\r\n                    if (!response.success) {\r\n                        clicktosend.trigger(errEvent, strings[0]);\r\n                    } else {\r\n                        Toast.add(strings[2]);\r\n                    }\r\n                    return true;\r\n                }).fail(Notification.exception);\r\n            });\r\n            modalRoot.find(CONSTANTS.close).remove();\r\n            modalRoot.find(CONSTANTS.closebtn).remove();\r\n            modalRoot.on(ModalEvents.save, modalSave);\r\n            modalRoot.on('submit', 'form', modalSave);\r\n            modalRoot.on(ModalEvents.shown, function () {\r\n                document.body.classList.add(CONSTANTS.authbodyclass);\r\n            });\r\n            modalRoot.on(ModalEvents.hidden, function () {\r\n                document.body.classList.remove(CONSTANTS.authbodyclass);\r\n            });\r\n            setTimeout(function () {\r\n                modal.show();\r\n                displayErrors.enhance(CONSTANTS.codeinput.replace('#', ''));\r\n                displayErrors.enhance(CONSTANTS.clicktosend.replace('#', ''));\r\n            }, sectomilisec(timeInterval));\r\n            return true;\r\n        }).fail(Notification.exception);\r\n    }\r\n\r\n    return {init: init};\r\n});\r\n"],"names":["define","$","Modal","ModalEvents","Ajax","Templates","Notification","Event","Str","displayErrors","Loader","config","Toast","formEvents","component","CONSTANTS","modaltemplate","mailaction","close","closebtn","codeinput","clicktosend","mailajax","authajax","content","authbodyclass","sectomilisec","sec","init","timeInterval","when","get_strings","key","render","then","strings","htmljs","runTemplateJS","modal","ModalSaveCancel","modalRoot","getRoot","find","errEvent","Events","FORM_FIELD_VALIDATION","modalContent","modalSave","e","preventDefault","notifyFieldValidationFailure","codeval","val","trim","length","promises","call","methodname","args","contextid","authcode","addIconToContainerRemoveOnCompletion","response","success","hide","nexttick","setInterval","show","fail","exception","getModal","attr","on","trigger","add","remove","save","shown","document","body","classList","hidden","setTimeout","enhance","replace"],"mappings":"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"}