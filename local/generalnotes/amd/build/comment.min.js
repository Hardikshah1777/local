define ("local_generalnotes/comment",["core/yui","core/config"],function(a,b){var d=window.M.util.image_url,e=window.M.util.get_string;function c(b){var c=this;this.client_id=b.client_id;this.itemid=b.itemid;this.commentarea=b.commentarea;this.component=b.component;this.courseid=b.courseid;this.contextid=b.contextid;this.autostart=b.autostart;if(this.autostart){this.view(b.page)}var d=a.one("#comment-link-"+this.client_id);if(d){if(b.notoggle){d.setStyle("display","none")}d.on("click",function(a){a.preventDefault();this.view(0);return!1},this);d.on("key",function(a){a.preventDefault();this.view(0);return!1},"13,32",this)}c.toggle_textarea(!1)}c.prototype.api=b.wwwroot+"/local/generalnotes/ajax.php";c.prototype.post=function(){var b=a.one("#dlg-content-"+this.client_id),c=this,f=b.get("value");if(f&&f!=e("addcomment","moodle")){b.set("disabled",!0);b.setStyles({backgroundImage:"url("+d("i/loading_small","core")+")",backgroundRepeat:"no-repeat",backgroundPosition:"center center"});this.request({action:"add",scope:c,params:{content:f},callback:function callback(b,c,d){var f=d.scope,g=f.client_id,h=a.one("#dlg-content-"+g);h.set("value","");h.set("disabled",!1);h.setStyle("backgroundImage","none");f.toggle_textarea(!1);var j=a.one("#comment-list-"+g),k=f.render([c]),l=a.Node.create(k.html);j.insertBefore(l,j.one("li"));var m=a.one("#comment-link-text-"+g);if(m){m.set("innerHTML",e("commentscount","moodle",c.count))}f.register_pagination();f.register_delete_buttons()}},!0)}};c.prototype.request=function(b,c){var d={},e=this;if(b.scope){e=b.scope}d.sesskey=M.cfg.sesskey;d.action=b.action?b.action:"";d.client_id=this.client_id;d.contextid=this.contextid;if(b.params){for(i in b.params){d[i]=b.params[i]}}var f={method:"POST",on:{complete:function complete(c,d,e){if(!d){alert("IO FATAL");return!1}var f=a.JSON.parse(d.responseText);if(f.error){if("require_login"==f.error){b.callback(c,f,e);return!0}alert(f.error);return!1}else{b.callback(c,f,e);return!0}}},arguments:{scope:e},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:build_querystring(d)};if(b.form){f.form=b.form}a.io(this.api,f);if(!c){this.wait()}};c.prototype.render=function(b,c){var d={ids:[]},f=a.one("#cmt-tmpl"),g="";for(var h in b){var j="comment-"+b[h].id+"-"+this.client_id,k=f.get("innerHTML");if(b[h].profileurl){k=k.replace("___name___","<a href=\""+b[h].profileurl+"\">"+b[h].fullname+"</a>")}else{k=k.replace("___name___",b[h].fullname)}if(b[h]["delete"]||c){var l={user:b[h].fullname,time:b[h].time},m=a.Escape.html(e("deletecommentbyon","moodle",l));b[h].content="<div class=\"comment-delete\"><a href=\"#\" role=\"button\" id =\"comment-delete-"+this.client_id+"-"+b[h].id+"\"   title=\""+m+"\"><span></span></a></div>"+b[h].content}k=k.replace("___time___",b[h].time);k=k.replace("___picture___",b[h].avatar);k=k.replace("___content___",b[h].content);k="<li id=\""+j+"\">"+k+"</li>";d.ids.push(j);g=g+k}d.html=g;return d};c.prototype.load=function(b){var c=this,f=a.one("#comment-ctrl-"+this.client_id);this.request({scope:c,params:{action:"get",page:b},callback:function callback(b,f,g){var h=a.one("#comment-link-text-"+c.client_id);if(f.count&&h){h.set("innerHTML",e("commentscount","moodle",f.count))}var j=a.one("#comment-list-"+c.client_id),k=a.one("#comment-pagination-"+c.client_id);if(f.pagination){k.set("innerHTML",f.pagination)}else{k.set("innerHTML","")}if("require_login"==f.error){var l={html:e("commentsrequirelogin","moodle")}}else{var l=c.render(f.list)}j.set("innerHTML",l.html);var m=a.one("#comment-img-"+c.client_id);if(m){m.set("src",d("t/expanded","core"))}g.scope.register_pagination();g.scope.register_delete_buttons()}})};c.prototype.dodelete=function(b){var d=this,f=d.client_id;function c(b){b.remove();var c=a.one("#comment-link-text-"+f),d=a.all("#comment-list-"+f+" li");if(c&&d){c.set("innerHTML",e("commentscount","moodle",d.size()))}}this.request({action:"delete",scope:d,params:{commentid:b},callback:function callback(b,d){var e="comment-"+d.commentid+"-"+d.client_id,f=a.one("#"+e);c(f)}},!0)};c.prototype.register_actions=function(){var b=a.one("#comment-action-post-"+this.client_id);if(b){b.on("click",function(a){a.preventDefault();this.post();return!1},this)}var c=a.one("#comment-action-cancel-"+this.client_id);if(c){c.on("click",function(a){a.preventDefault();this.view(0);return!1},this)}};c.prototype.register_delete_buttons=function(){var b=this;a.all("div.comment-delete a").each(function(c){var d=c.get("id"),e=new RegExp("comment-delete-"+b.client_id+"-(\\d+)","i"),f=d.match(e);if(!f){return}if(f[1]){a.Event.purgeElement("#"+d,!1,"click")}c.on("click",function(a){a.preventDefault();if(f[1]){b.dodelete(f[1])}});c.on("key",function(a){a.preventDefault();if(f[1]){b.dodelete(f[1])}},"13,32");require(["core/templates","core/notification"],function(a,b){var d=c.getAttribute("title");a.renderPix("t/delete","core",d).then(function(a){c.set("innerHTML",a)}).catch(b.exception)})})};c.prototype.register_pagination=function(){var b=this;a.all("#comment-pagination-"+this.client_id+" a").each(function(a){a.on("click",function(a,b){a.preventDefault();var c=b.get("id"),d=new RegExp("comment-page-"+this.client_id+"-(\\d+)","i"),e=c.match(d);this.load(e[1])},b,a)})};c.prototype.view=function(b){var c=a.one("#comment-link-"+this.client_id),e=a.one("#comment-ctrl-"+this.client_id),f=a.one("#dlg-content-"+this.client_id),g=a.one("#comment-img-"+this.client_id),h=e.getStyle("display");if("none"==h||""==h){if(!this.autostart){this.load(b)}else{this.register_delete_buttons();this.register_pagination()}e.setStyle("display","block");if(g){g.set("src",d("t/expanded","core"))}if(c){c.setAttribute("aria-expanded","true")}}else{e.setStyle("display","none");var j="t/collapsed";if(a.one(document.body).hasClass("dir-rtl")){j="t/collapsed_rtl"}else{j="t/collapsed"}if(g){g.set("src",d(j,"core"))}if(f){f.set("value","")}if(c){c.setAttribute("aria-expanded","false")}}if(f){f.on("focus",function(){this.toggle_textarea(!0)},this);f.on("blur",function(){this.toggle_textarea(!1)},this)}this.register_actions();return!1};c.prototype.toggle_textarea=function(b){var c=a.one("#dlg-content-"+this.client_id);if(!c){return!1}if(b){if(c.get("value")==e("addcomment","moodle")){c.set("value","");c.setStyle("color","black")}}else{if(""==c.get("value")){c.set("value",e("addcomment","moodle"));c.setStyle("color","grey");c.set("rows",2)}}};c.prototype.wait=function(){var b=a.one("#comment-list-"+this.client_id);b.set("innerHTML","<div class=\"mdl-align\"><img src=\""+d("i/loading_small","core")+"\" /></div>")};return{init:function init(a){return new c(a)}}});
//# sourceMappingURL=comment.min.js.map
