{"version":3,"file":"reset.min.js","sources":["../src/reset.js"],"sourcesContent":["import $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport * as Str from 'core/str';\nimport {addIconToContainer} from 'core/loadingicon';\nimport Log from 'core/log';\nimport {get_string as getString} from \"core/str\";\nimport ModalForm from 'core_form/modalform';\nimport {add as addToast} from 'core/toast';\nimport {defaultException} from 'core/notification';\n\nconst SELECTORS = {\n    resetbtn: '[id=\"resetbtn\"]'\n};\n\nconst COMPONENT = 'local_squibit';\n\nconst TIME = 5 * 1000;\n\nconst cache = {};\n\nconst showToolip = (btn, value, isshow) => {\n    return getString(`resetremainingmsg`, COMPONENT, value).then(str => {\n        $(btn).tooltip('hide')\n            .attr('data-original-title', str)\n            .tooltip('show');\n        if (isshow === true) {\n            $(btn).tooltip('hide');\n        }\n    });\n};\n\nexport const init = () => {\n    var button = document.querySelector(SELECTORS.resetbtn);\n\n    button.addEventListener('click', (e) => {\n        e.preventDefault();\n\n        custommodal(\n            Str.get_string('confirmation', 'admin'),\n            Str.get_string('confirmationmsg', COMPONENT),\n            Str.get_string('yes', 'moodle')\n        ).then(function(confirmationmodal) {\n\n            confirmationmodal.getRoot().on(ModalEvents.save, function() {\n\n                const modalform = new ModalForm({\n                    formClass: \"local_squibit\\\\form\\\\authform\",\n                    modalConfig: {\n                        title: Str.get_string('authenticateuser', COMPONENT),\n                        buttons: {\n                            save: Str.get_string('save', 'moodle'),\n                        },\n                        large: false\n                    },\n                    args: {},\n                    returnFocus: button,\n                });\n                modalform.addEventListener(modalform.events.FORM_SUBMITTED,\n                    (responce) => {\n                        if (responce.detail) {\n                            var argsdata = {\n                                action: \"delete\",\n                            };\n                            Str.get_string('authenticatesuccess', COMPONENT)\n                                .then(addToast).catch(defaultException);\n                            callapi(button, argsdata);\n                        }\n                    }\n                );\n                modalform.show();\n            });\n            confirmationmodal.show();\n        });\n    });\n};\n\nexport const custommodal = (title, body, savebtn) => {\n    return ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: title,\n        body: body,\n        buttons: {\n            save: savebtn,\n        },\n    });\n};\n\n\nexport const callapi = (button, argsdata, lastloader) => {\n    return addIconToContainer(button).then(loadingIcon => {\n        if (lastloader) {\n            lastloader.remove();\n        }\n        return Ajax.call([{\n            methodname: 'local_squibit_sync_all_reset',\n            args: argsdata\n        }])[0].then(({result, usercount, coursecount}) => {\n            if (usercount === 0 && coursecount === 0 && !result) {\n                const btnvalue = {\n                    usercount: 0,\n                    coursecount: 0\n                };\n                loadingIcon.remove();\n                button.classList.remove('disabled');\n                showToolip(button, btnvalue, true);\n                location.reload();\n                return true;\n            }\n            if (usercount > 0 || coursecount > 0) {\n                if (cache.usercount !== usercount) {\n                    cache.usercount = usercount;\n                }\n                if (cache.coursecount !== coursecount) {\n                    cache.coursecount = coursecount;\n                }\n                button.classList.add('disabled');\n                const btnvalue = {\n                    usercount: usercount,\n                    coursecount: coursecount\n                };\n                showToolip(button, btnvalue, false);\n                argsdata.action = '';\n                setTimeout(() => callapi(button, argsdata, loadingIcon), TIME);\n            } else {\n                button.classList.remove('disabled');\n            }\n\n            return ((usercount === '') ? ((coursecount === '') ? false : coursecount) : usercount);\n        }).catch(Log.debug);\n    });\n};\n"],"names":["SELECTORS","cache","showToolip","btn","value","isshow","then","str","tooltip","attr","button","document","querySelector","addEventListener","e","preventDefault","custommodal","Str","get_string","confirmationmodal","getRoot","on","ModalEvents","save","modalform","ModalForm","formClass","modalConfig","title","buttons","large","args","returnFocus","events","FORM_SUBMITTED","responce","detail","addToast","catch","defaultException","callapi","action","show","body","savebtn","ModalFactory","create","type","types","SAVE_CANCEL","argsdata","lastloader","loadingIcon","remove","Ajax","call","methodname","_ref","result","usercount","coursecount","btnvalue","classList","location","reload","add","setTimeout","Log","debug"],"mappings":"srDAYMA,mBACQ,kBAORC,MAAQ,GAERC,WAAa,CAACC,IAAKC,MAAOC,UACrB,sCAPO,gBAOmCD,OAAOE,MAAKC,0BACvDJ,KAAKK,QAAQ,QACVC,KAAK,sBAAuBF,KAC5BC,QAAQ,SACE,IAAXH,4BACEF,KAAKK,QAAQ,yBAKP,SACZE,OAASC,SAASC,cAAcZ,oBAEpCU,OAAOG,iBAAiB,SAAUC,IAC9BA,EAAEC,iBAEFC,YACIC,IAAIC,WAAW,eAAgB,SAC/BD,IAAIC,WAAW,kBAzBT,iBA0BND,IAAIC,WAAW,MAAO,WACxBZ,MAAK,SAASa,mBAEZA,kBAAkBC,UAAUC,GAAGC,sBAAYC,MAAM,iBAEvCC,UAAY,IAAIC,mBAAU,CAC5BC,UAAW,gCACXC,YAAa,CACTC,MAAOX,IAAIC,WAAW,mBAlC5B,iBAmCMW,QAAS,CACLN,KAAMN,IAAIC,WAAW,OAAQ,WAEjCY,OAAO,GAEXC,KAAM,GACNC,YAAatB,SAEjBc,UAAUX,iBAAiBW,UAAUS,OAAOC,gBACvCC,cACOA,SAASC,OAAQ,CAIjBnB,IAAIC,WAAW,sBAjDzB,iBAkDeZ,KAAK+B,YAAUC,MAAMC,gCAC1BC,QAAQ9B,OALO,CACX+B,OAAQ,eAQxBjB,UAAUkB,UAEdvB,kBAAkBuB,oBAKjB1B,YAAc,CAACY,MAAOe,KAAMC,UAC9BC,uBAAaC,OAAO,CACvBC,KAAMF,uBAAaG,MAAMC,YACzBrB,MAAOA,MACPe,KAAMA,KACNd,QAAS,CACLN,KAAMqB,kDAMLJ,QAAU,CAAC9B,OAAQwC,SAAUC,cAC/B,mCAAmBzC,QAAQJ,MAAK8C,cAC/BD,YACAA,WAAWE,SAERC,cAAKC,KAAK,CAAC,CACdC,WAAY,+BACZzB,KAAMmB,YACN,GAAG5C,MAAKmD,WAACC,OAACA,OAADC,UAASA,UAATC,YAAoBA,qBACX,IAAdD,WAAmC,IAAhBC,cAAsBF,OAAQ,OAC3CG,SAAW,CACbF,UAAW,EACXC,YAAa,UAEjBR,YAAYC,SACZ3C,OAAOoD,UAAUT,OAAO,YACxBnD,WAAWQ,OAAQmD,UAAU,GAC7BE,SAASC,UACF,KAEPL,UAAY,GAAKC,YAAc,EAAG,CAC9B3D,MAAM0D,YAAcA,YACpB1D,MAAM0D,UAAYA,WAElB1D,MAAM2D,cAAgBA,cACtB3D,MAAM2D,YAAcA,aAExBlD,OAAOoD,UAAUG,IAAI,YAKrB/D,WAAWQ,OAJM,CACbiD,UAAWA,UACXC,YAAaA,cAEY,GAC7BV,SAAST,OAAS,GAClByB,YAAW,IAAM1B,QAAQ9B,OAAQwC,SAAUE,cA1G9C,UA4GG1C,OAAOoD,UAAUT,OAAO,kBAGL,KAAdM,UAAsC,KAAhBC,aAA8BA,YAAeD,aAC7ErB,MAAM6B,aAAIC"}