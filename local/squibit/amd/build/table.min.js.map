{"version":3,"file":"table.min.js","sources":["../src/table.js"],"sourcesContent":["/* eslint-disable consistent-return*/\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport {addIconToContainer} from 'core/loadingicon';\nimport Log from 'core/log';\nimport * as DynamicTable from 'core_table/dynamic';\nimport {get_string as getString} from 'core/str';\n// eslint-disable-next-line babel/no-unused-expressions\nimport('theme_boost/index');\n\nconst COMPONENT = 'local_squibit';\n\nconst SELECTORS = {\n    syncuser: '[data-action=\"syncuser\"]',\n    syncalluser: '[data-action=\"syncalluser\"]',\n    synccourse: '[data-action=\"synccourse\"]',\n    syncallcourse: '[data-action=\"syncallcourse\"]',\n};\n\nconst POLLINTVAL = 5 * 1000;\n\nconst ACTIONS = ['status', 'new', 'default'];\n\nconst cache = {};\n\nconst showToolip = (component) => {\n    if (!cache.count) {\n        return;\n    }\n    const type = component.getAttribute('data-type');\n    return getString(`${type}remaining`, COMPONENT, cache).then(str => {\n        $(component).tooltip('hide')\n            .attr('data-original-title', str)\n            .tooltip('show');\n        setTimeout(() => $(component).tooltip('hide'), 1000);\n    });\n};\n\nconst updateSyncStatus = (component, action = ACTIONS[2], lastloader) => {\n    if (!component) {\n        return;\n    }\n    const type = component.getAttribute('data-type');\n    const methodname = `${COMPONENT}_sync_all_${type}`;\n    return addIconToContainer(component).then(loadingIcon => {\n        if (lastloader) {\n            lastloader.remove();\n        }\n        return Ajax.call([{\n            methodname,\n            args: {\n                action\n            }\n        }])[0].then(({pending, count}) => {\n            var actionvalue = ACTIONS[0];\n            if (!pending) {\n                loadingIcon.remove();\n                actionvalue = ACTIONS[2];\n            }\n\n            if (cache.islast === true) {\n                location.reload();\n            }\n            if (count > 0) {\n                if (cache.count !== count) {\n                    cache.count = count;\n                    showToolip(component);\n                }\n                component.setAttribute('disabled', 'disabled');\n                if (cache.count === 1) {\n                    cache.islast = true;\n                }\n                setTimeout(() => updateSyncStatus(component, actionvalue, loadingIcon), POLLINTVAL);\n            } else {\n                component.removeAttribute('disabled');\n            }\n            return count;\n        }).catch(Log.debug);\n    });\n};\n\nexport const tableRegister = (tableUniqId) => {\n    const syncalluser = document.querySelector(SELECTORS.syncalluser);\n    if (syncalluser) {\n        updateSyncStatus(syncalluser);\n    }\n    document.addEventListener('click', e => {\n        const syncuser = e.target.closest(SELECTORS.syncuser);\n        if (syncuser) {\n            addIconToContainer(syncuser).then(loadingIcon => {\n                const userid = syncuser.getAttribute('data-userid');\n                const promise = Ajax.call([{\n                    methodname: `${COMPONENT}_sync_user`,\n                    args: {\n                        userid,\n                    }\n                }])[0];\n                promise.then(response => {\n                    Log.debug(response);\n                    const tableRoot = DynamicTable.getTableFromId(tableUniqId);\n                    DynamicTable.refreshTableContent(tableRoot, false);\n                    loadingIcon.remove();\n                });\n            });\n        }\n        const syncalluser = e.target.closest(SELECTORS.syncalluser);\n        if (syncalluser) {\n            if (!syncalluser.disabled) {\n                updateSyncStatus(syncalluser, ACTIONS[1]);\n            } else {\n                showToolip(syncalluser);\n            }\n        }\n    });\n\n    const syncallcourse = document.querySelector(SELECTORS.syncallcourse);\n    if (syncallcourse) {\n        updateSyncStatus(syncallcourse);\n    }\n    document.addEventListener('click', e => {\n        const synccourse = e.target.closest(SELECTORS.synccourse);\n        if (synccourse) {\n            addIconToContainer(synccourse).then(loadingIcon => {\n                const courseid = synccourse.getAttribute('data-courseid');\n                const promise = Ajax.call([{\n                    methodname: `${COMPONENT}_sync_course`,\n                    args: {\n                        courseid,\n                    }\n                }])[0];\n                promise.then(response => {\n                    Log.debug(response);\n                    const tableRoot = DynamicTable.getTableFromId(tableUniqId);\n                    DynamicTable.refreshTableContent(tableRoot, false);\n                    loadingIcon.remove();\n                });\n            });\n        }\n        const syncallcourse = e.target.closest(SELECTORS.syncallcourse);\n        if (syncallcourse) {\n            if (!syncallcourse.disabled) {\n                updateSyncStatus(syncallcourse, ACTIONS[1]);\n            } else {\n                showToolip(syncallcourse);\n            }\n        }\n    });\n};\n"],"names":["COMPONENT","SELECTORS","ACTIONS","cache","showToolip","component","count","type","getAttribute","then","str","tooltip","attr","setTimeout","updateSyncStatus","action","lastloader","methodname","loadingIcon","remove","Ajax","call","args","_ref","pending","actionvalue","islast","location","reload","setAttribute","removeAttribute","catch","Log","debug","tableUniqId","syncalluser","document","querySelector","addEventListener","e","syncuser","target","closest","userid","response","tableRoot","DynamicTable","getTableFromId","refreshTableContent","disabled","syncallcourse","synccourse","courseid"],"mappings":"+oEAUMA,UAAY,gBAEZC,mBACQ,2BADRA,sBAEW,8BAFXA,qBAGU,6BAHVA,wBAIa,gCAKbC,QAAU,CAAC,SAAU,MAAO,WAE5BC,MAAQ,GAERC,WAAcC,gBACXF,MAAMG,mBAGLC,KAAOF,UAAUG,aAAa,oBAC7B,6BAAaD,kBAAiBP,UAAWG,OAAOM,MAAKC,0BACtDL,WAAWM,QAAQ,QAChBC,KAAK,sBAAuBF,KAC5BC,QAAQ,QACbE,YAAW,KAAM,mBAAER,WAAWM,QAAQ,SAAS,SAIjDG,iBAAmB,SAACT,eAAWU,8DAASb,QAAQ,GAAIc,sDACjDX,uBAGCE,KAAOF,UAAUG,aAAa,aAC9BS,qBAAgBjB,+BAAsBO,aACrC,mCAAmBF,WAAWI,MAAKS,cAClCF,YACAA,WAAWG,SAERC,cAAKC,KAAK,CAAC,CACdJ,WAAAA,WACAK,KAAM,CACFP,OAAAA,WAEJ,GAAGN,MAAKc,WAACC,QAACA,QAADlB,MAAUA,gBACfmB,YAAcvB,QAAQ,UACrBsB,UACDN,YAAYC,SACZM,YAAcvB,QAAQ,KAGL,IAAjBC,MAAMuB,QACNC,SAASC,SAETtB,MAAQ,GACJH,MAAMG,QAAUA,QAChBH,MAAMG,MAAQA,MACdF,WAAWC,YAEfA,UAAUwB,aAAa,WAAY,YACf,IAAhB1B,MAAMG,QACNH,MAAMuB,QAAS,GAEnBb,YAAW,IAAMC,iBAAiBT,UAAWoB,YAAaP,cArDvD,MAuDHb,UAAUyB,gBAAgB,YAEvBxB,SACRyB,MAAMC,aAAIC,kCAISC,oBACpBC,YAAcC,SAASC,cAAcpC,uBACvCkC,aACArB,iBAAiBqB,aAErBC,SAASE,iBAAiB,SAASC,UACzBC,SAAWD,EAAEE,OAAOC,QAAQzC,oBAC9BuC,8CACmBA,UAAU/B,MAAKS,oBACxByB,OAASH,SAAShC,aAAa,eACrBY,cAAKC,KAAK,CAAC,CACvBJ,qBAAejB,wBACfsB,KAAM,CACFqB,OAAAA,WAEJ,GACIlC,MAAKmC,wBACLX,MAAMW,gBACJC,UAAYC,aAAaC,eAAeb,aAC9CY,aAAaE,oBAAoBH,WAAW,GAC5C3B,YAAYC,qBAIlBgB,YAAcI,EAAEE,OAAOC,QAAQzC,uBACjCkC,cACKA,YAAYc,SAGb7C,WAAW+B,aAFXrB,iBAAiBqB,YAAajC,QAAQ,cAO5CgD,cAAgBd,SAASC,cAAcpC,yBACzCiD,eACApC,iBAAiBoC,eAErBd,SAASE,iBAAiB,SAASC,UACzBY,WAAaZ,EAAEE,OAAOC,QAAQzC,sBAChCkD,gDACmBA,YAAY1C,MAAKS,oBAC1BkC,SAAWD,WAAW3C,aAAa,iBACzBY,cAAKC,KAAK,CAAC,CACvBJ,qBAAejB,0BACfsB,KAAM,CACF8B,SAAAA,aAEJ,GACI3C,MAAKmC,wBACLX,MAAMW,gBACJC,UAAYC,aAAaC,eAAeb,aAC9CY,aAAaE,oBAAoBH,WAAW,GAC5C3B,YAAYC,qBAIlB+B,cAAgBX,EAAEE,OAAOC,QAAQzC,yBACnCiD,gBACKA,cAAcD,SAGf7C,WAAW8C,eAFXpC,iBAAiBoC,cAAehD,QAAQ"}