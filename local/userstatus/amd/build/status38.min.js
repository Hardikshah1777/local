define ("local_userstatus/status38",["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/notification","core/config","core/yui","core/ajax"],function(a,b,c,d,e,f,g,h,j){var k={BULKACTIONSELECT:"#formactioncustom",BULKUSERCHECKBOXES:"input.usercheckbox",BULKUSERNOSCHECKBOXES:"input.usercheckbox[value='0']",BULKUSERSELECTEDCHECKBOXES:"input.usercheckbox:checked",BULKACTIONFORM:"#participantsform",CHECKALLBUTTON:"#checkall",CHECKALLNOSBUTTON:"#checkallnos",STATUSCHANGER:"#statuschanger",mailtemplate:"#id_mailtemplate",mailbody:"#id_mailbody"},l=g.wwwroot+"/local/userstatus/ajax.php",m=function(a){this.courseId=a.courseid;this.statuses=a.statuses;this.templates=a.templates;this.notemplateid=parseInt(a.notemplateid);this.userindex=a.userindex||!1;this.noteStateNames=a.noteStateNames;this.stateHelpIcon=a.stateHelpIcon;this.attachEventListeners()};m.prototype.courseId=-1;m.prototype.attachEventListeners=function(){var c=a(k.BULKACTIONSELECT);a(k.BULKACTIONSELECT).on("change",function(b){var c=a(b.target).val();if(-1!==c.indexOf("#")){b.preventDefault();var d=[];a(k.BULKUSERSELECTEDCHECKBOXES).each(function(b,c){var e=a(c).attr("name"),f=e.replace("user","");d.push(f)});if("#messageselect"==c){this.showSendMessage(d).fail(f.exception)}else if("#addgroupnote"==c){this.showAddNote(d).fail(f.exception)}a(k.BULKACTIONSELECT+" option[value=\"\"]").prop("selected","selected")}else if(""!==c){if(0<a(k.BULKUSERSELECTEDCHECKBOXES).length){a(k.BULKACTIONFORM).submit()}else{a(k.BULKACTIONSELECT+" option[value=\"\"]").prop("selected","selected")}}}.bind(this));if(0<c.length){a(k.BULKACTIONFORM).attr("data-enhanced",!0);var d=window.M.util.add_lightbox(h,h.Node(document.querySelector(k.BULKACTIONFORM))),i={sesskey:g.sesskey,id:this.courseId,userids:[],action:"get"},j=this;b.get_strings([{key:"changestatus",component:"local_userstatus"},{key:"choose"}]).then(function(b){var c=a("<label for=\"statuschanger\" class=\"col-form-label d-inline ml-2\">"+b[0]+"</label>");c.insertAfter(a(k.BULKACTIONSELECT));var f=a("<select id=\"statuschanger\" class=\"custom-select mr-2\" disabled></select>");f.append("<option value=\"\">"+b[1]+"</option>");a.each(this.statuses,function(a,b){f.append("<option value=\""+a+"\">"+b+"</option>")});f.insertAfter(c);var g={};a(k.BULKUSERCHECKBOXES).each(function(b,c){var d=c.name.replace("user","");i.userids.push(d);g[d]=a(c).parents("tr")}).on("change",function(){f.prop("disabled",0===a(k.BULKUSERSELECTEDCHECKBOXES).length)});if(0<i.userids.length){d.show();a.post(l,i).done(function(b){if(b.success&&b.users){a.each(b.users,function(a,b){if(j.userindex){g[a].find(".c1").append(b)}else{g[a].find("[data-statusid]").replaceWith(b)}})}i.action="put";i.userids=[];d.hide()})}f.on("change",function(b){i.status=a(b.target).val();i.userids=[];a(k.BULKUSERSELECTEDCHECKBOXES).each(function(a,b){var c=b.name.replace("user","");i.userids.push(c)});if(0===i.userids.length||""===i.status){return}f.prop("disabled",!0);d.show();a.post(l,i).done(function(b){if(b.success&&b.users){a.each(b.users,function(a,b){g[a].find("[data-statusid]").replaceWith(b)})}f.val("").prop("disabled",!1);setTimeout(function(){d.hide()},500)})})}.bind(this)).fail(f.exception)}};m.prototype.showSendMessage=function(f){if(0==f.length){return a.Deferred().resolve().promise()}var g=null;if(1==f.length){g=b.get_string("sendbulkmessagesingle","core_message")}else{g=b.get_string("sendbulkmessage","core_message",f.length)}return a.when(c.create({type:c.types.SAVE_CANCEL,body:e.render("local_userstatus/send_bulk_message",{templates:this.templates,notemplateid:this.notemplateid})}),g).then(function(b,c){this.modal=b;this.modal.setTitle(c);this.modal.setSaveButtonText(c);this.modal.getRoot().on(d.hidden,function(){a(k.BULKACTIONSELECT).focus();this.modal.getRoot().remove()}.bind(this));this.modal.getRoot().on(d.save,this.submitSendMessage.bind(this,f));this.modal.show();var e={};this.templates.forEach(function(a){e[parseInt(a.id)]=a});e[this.notemplateid]={message:""};this.modal.getRoot().on("change",function(a){var b=document.querySelector(k.mailtemplate),c=document.querySelector(k.mailbody),d=parseInt(b.value);if(b.contains(a.target)){c.value=e[d].message;return!0}if(d!==this.notemplateid){return!1}if(c.contains(a.target)){e[this.notemplateid].message=c.value}}.bind(this));return this.modal}.bind(this))};m.prototype.submitSendMessage=function(a){var c=this.modal.getRoot().find("form textarea").val(),d=[],e=0;for(e=0;e<a.length;e++){d.push({touserid:a[e],text:c})}return j.call([{methodname:"local_userstatus_send_instant_messages",args:{messages:d}}])[0].then(function(a){if(1==a.length){return b.get_string("sendbulkmessagesentsingle","core_message")}else{return b.get_string("sendbulkmessagesent","core_message",a.length)}}).then(function(a){f.addNotification({message:a,type:"success"});return!0}).catch(f.exception)};m.prototype.showAddNote=function(f){if(0==f.length){return a.Deferred().resolve().promise()}var g=[];for(var h in this.noteStateNames){switch(h){case"draft":g.push({value:"personal",label:this.noteStateNames[h]});break;case"public":g.push({value:"course",label:this.noteStateNames[h],selected:1});break;case"site":g.push({value:h,label:this.noteStateNames[h]});break;}}var i={stateNames:g,stateHelpIcon:this.stateHelpIcon},j=null;if(1==f.length){j=b.get_string("addbulknotesingle","core_notes")}else{j=b.get_string("addbulknote","core_notes",f.length)}return a.when(c.create({type:c.types.SAVE_CANCEL,body:e.render("core_user/add_bulk_note",i)}),j).then(function(b,c){this.modal=b;this.modal.setTitle(c);this.modal.setSaveButtonText(c);this.modal.getRoot().on(d.hidden,function(){var b=a("#user-notifications [role=alert]");if(b.length){b.focus()}else{a(k.BULKACTIONSELECT).focus()}this.modal.getRoot().remove()}.bind(this));this.modal.getRoot().on(d.save,this.submitAddNote.bind(this,f));this.modal.show();return this.modal}.bind(this))};m.prototype.submitAddNote=function(a){var c=this.modal.getRoot().find("form textarea").val(),d=this.modal.getRoot().find("form select").val(),e=[],g=0;for(g=0;g<a.length;g++){e.push({userid:a[g],text:c,courseid:this.courseId,publishstate:d})}return j.call([{methodname:"core_notes_create_notes",args:{notes:e}}])[0].then(function(a){if(1==a.length){return b.get_string("addbulknotedonesingle","core_notes")}else{return b.get_string("addbulknotedone","core_notes",a.length)}}).then(function(a){f.addNotification({message:a,type:"success"});return!0}).catch(f.exception)};return{init:function init(a){return new m(a)}}});
//# sourceMappingURL=status38.min.js.map
